<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>For You ❤️</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            height: 100vh;
            overflow: hidden;
            perspective: 2000px;
            touch-action: none; /* Prevent browser handling of swipes */
        }

        .book-container {
            width: 100%;
            height: 100vh;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .page {
            position: absolute;
            width: 100%;
            height: 100%;
            transform-origin: left center;
            transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1);
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            will-change: transform;
        }

        .page-front, .page-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            background: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        .page-back {
            transform: rotateY(180deg);
        }

        .page img {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            pointer-events: none;
            user-select: none;
            -webkit-user-select: none;
        }

        .page.flipped {
            transform: rotateY(-180deg);
        }

        /* Rest of your existing styles remain the same */
        /* ... */
    </style>
</head>
<body>
    <!-- Your existing HTML structure remains the same -->
    <!-- ... -->

    <script>
        let currentPage = 0;
        let isAnimating = false;
        let touchStartX = 0;
        let touchStartY = 0;
        let currentTouchX = 0;
        let isSwiping = false;
        let swipeDirection = null;
        let initialTouchTime = 0;

        // Your existing initialization code remains the same
        // ...

        // Enhanced touch handling
        container.addEventListener('touchstart', (e) => {
            if (isAnimating) return;
            
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            currentTouchX = touchStartX;
            initialTouchTime = Date.now();
            isSwiping = true;
            swipeDirection = null;
            
            // Reset any existing transforms
            pages.forEach(page => {
                page.style.transition = 'none';
                if (!page.classList.contains('flipped')) {
                    page.style.transform = '';
                }
            });

            attemptPlayMusic();
        }, { passive: true });

        container.addEventListener('touchmove', (e) => {
            if (!isSwiping) return;
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - touchStartX;
            const deltaY = touchY - touchStartY;
            currentTouchX = touchX;

            // Determine swipe direction if not yet set
            if (!swipeDirection) {
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    swipeDirection = 'horizontal';
                } else {
                    swipeDirection = 'vertical';
                }
            }

            // Only handle horizontal swipes
            if (swipeDirection === 'horizontal') {
                e.preventDefault();

                const currentPageElement = pages[currentPage];
                const nextPageElement = pages[currentPage + 1];
                const prevPageElement = pages[currentPage - 1];

                // Calculate rotation based on swipe distance
                const swipePercent = deltaX / window.innerWidth;
                const rotation = swipePercent * -180;

                if (deltaX < 0 && currentPage < totalPages - 1) {
                    // Swiping forward
                    if (currentPageElement) {
                        currentPageElement.style.transition = 'none';
                        currentPageElement.style.transform = `rotateY(${rotation}deg)`;
                    }
                } else if (deltaX > 0 && currentPage > 0) {
                    // Swiping backward
                    if (prevPageElement) {
                        prevPageElement.style.transition = 'none';
                        prevPageElement.style.transform = `rotateY(${-180 + rotation}deg)`;
                    }
                }
            }
        }, { passive: false });

        container.addEventListener('touchend', (e) => {
            if (!isSwiping) return;
            
            const touchEndX = e.changedTouches[0].clientX;
            const deltaX = touchStartX - touchEndX;
            const touchDuration = Date.now() - initialTouchTime;
            const velocity = Math.abs(deltaX) / touchDuration;

            // Reset transitions
            pages.forEach(page => {
                page.style.transition = 'transform 0.8s cubic-bezier(0.645, 0.045, 0.355, 1)';
            });

            if (swipeDirection === 'horizontal') {
                const swipeThreshold = window.innerWidth * 0.25; // 25% of screen width
                const velocityThreshold = 0.5; // pixels per millisecond

                if (Math.abs(deltaX) > swipeThreshold || velocity > velocityThreshold) {
                    if (deltaX > 0 && currentPage > 0) {
                        previousPage();
                    } else if (deltaX < 0 && currentPage < totalPages - 1) {
                        nextPage();
                    } else {
                        resetPages();
                    }
                } else {
                    resetPages();
                }
            }

            isSwiping = false;
            swipeDirection = null;
        }, { passive: true });

        function resetPages() {
            const currentPageElement = pages[currentPage];
            const prevPageElement = pages[currentPage - 1];
            
            if (currentPageElement) {
                currentPageElement.style.transform = '';
            }
            if (prevPageElement) {
                prevPageElement.style.transform = 'rotateY(-180deg)';
            }
        }

        // Update your existing nextPage and previousPage functions
        function nextPage() {
            if (currentPage < totalPages - 1 && !isAnimating) {
                isAnimating = true;
                turnPage('forward');
                currentPage++;
                updatePages();
                setTimeout(() => {
                    isAnimating = false;
                }, 800);
            }
        }

        function previousPage() {
            if (currentPage > 0 && !isAnimating) {
                isAnimating = true;
                turnPage('backward');
                currentPage--;
                updatePages();
                setTimeout(() => {
                    isAnimating = false;
                }, 800);
            }
        }

        // The rest of your existing code remains the same
        // ...
    </script>
</body>
</html>
